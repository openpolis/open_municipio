{% extends "acts/act_section.html" %}
{% load i18n %}
{% load om_comments_tags %}
{% load comments %}
{% load voting_tags %}
{% load newscache_tags %}

{% block title %}| Dettaglio {{ act }}{% endblock title %}
{% block content_header %}Dettaglio atto{% endblock %}
{% block acts_class %}class="active"{% endblock %}

{% block head_css_includes %}
    {{ block.super }}
    {% if user.is_staff %}
    <!-- required for TextboxList -->
    <link rel="stylesheet" href="{{ STATIC_URL }}css/textboxlist.css" type="text/css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}css/ui-custom-theme/jquery-ui-1.8.16.custom.css" type="text/css" />
    {% endif %}
    <link href="{{ STATIC_URL }}css/voting.css" rel="stylesheet">    
{% endblock head_css_includes %}

{% block head_js_includes %}
    {{ block.super }}
    <script src="{{ STATIC_URL }}js/ajax_csrf.js" type="text/javascript" charset="utf-8"></script>
    {% if user.is_staff %}
    <!-- required for TextboxList -->
    <script src="{{ STATIC_URL }}js/GrowingInput.js" type="text/javascript" charset="utf-8"></script>
    <script src="{{ STATIC_URL }}js/TextboxList.js" type="text/javascript" charset="utf-8"></script>        
    <script src="{{ STATIC_URL }}js/TextboxList.Autocomplete.js" type="text/javascript" charset="utf-8"></script>
    <script src="{{ STATIC_URL }}js/TextboxList.Autocomplete.Binary.js" type="text/javascript" charset="utf-8"></script>
    <script src="{{ STATIC_URL }}js/bootstrap-modal.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/jquery.cteditor.js" type="text/javascript"></script>
    {% endif %}
    <script src="{{ STATIC_URL }}js/voting.js" type="text/javascript"></script>
{% endblock head_js_includes %}

{% block footer_js_includes %}
<script type="text/javascript">
    require(["bootstrap-modal"], function() {
        // on scripts loaded...
        $('a.transaction_edit').each(function() {
            var link = $(this);
            link.click(function(e) {
                e.preventDefault();
                console.log(link.attr('href'));
                $(link.attr('href')).modal();
            });
            link.parent().hover(
                    function() { link.fadeIn(); },
                    function() { link.fadeOut(); }
            );
        });
    });
</script>
{% endblock %}

{% block extra_js %}
$(document).ready(function() {
    $('#cteditor-launcher').click(function(event){
        event.preventDefault();
        $('#cteditor').cteditor();
    }).parent().hover(
        function() { $('#cteditor-launcher', this).fadeIn(); }, 
        function() { $('#cteditor-launcher', this).fadeOut(); }
    );
});

{% endblock extra_js %}



{% block content %}
    <hgroup>
        <table class="pull-right">
            <tr>
                <th><span class="lightgraybox smallbox">Prossima discussione</span></th>
                <td><span class="graybox smallbox">3.3.2012</span></td>
            </tr>
        </table>
        <h2>
            <strong>{% block act_type %}TIPO ATTO{% endblock %}</strong>
            del Consiglio comunale NÂ° {{ act.idnum }} del <span class="date">{{ act.presentation_date }}</span></small>
        </h2>
        <h1><strong>{{ act.title }}</strong> ({{ act.idnum }})</h1>
    </hgroup>

    <p class="well">{{ act.text|safe }}</p>

    <ul class="nav nav-tabs">
      <li {% block act_tab_status_class %}class="active"{% endblock %}> <a href="{{ act.get_absolute_url }}">Stato</a></li>
      <li {% block act_tab_documents_class %}{% endblock %}><a href="{{ act.get_absolute_url }}documents">Documenti</a></li>
      <li><a href="{{ act.get_absolute_url }}votes"><strong>Voti</strong></a></li>
    </ul>

    {% block act_tab_body %}
        {% include 'acts/act_table_transitions.html' %}
    {% endblock act_tab_body %}

    {% load web_services_tags %}
    {% share act %}
{% endblock content %}


{% block sidebar %}

<section>
    {% include 'acts/act_tags_editor.html' %}
    <h3>Argomenti dell'atto</h3>
    
    <dl class="tags-cloud">
        {% for category in act.categories %}
        <dt><a href="{{ category.get_absolute_url }}">{{ category.name }}</a></dt>
        {% for tag in category.tags %}
            <dd><a href="{{ tag.get_absolute_url }}">{{ tag }}</a></dd>
        {% endfor %}
        {% endfor %}
    </dl>
    
</section>

<section><h3>Monitora</h3>
    <table>
        <tr>
            <td><span class="bluebox">{{ act.monitoring_users|length}}</span></td>
            <th class="bg-dark span12">
                utenti che monitorano l'atto<br />
                {% for user in act.monitoring_users %}
                  <a href="{{ user.get_absolute_url }}">{{ user.get_profile.public_name }}</a>
                  {% if forloop.last %}<br/>{% else %},{% endif %}
                {% endfor %}
                
                {% if user.is_authenticated %}
                  {% if is_user_monitoring %}
                  <form action="{% url om_monitoring_stop %}" method="post">
                    {% csrf_token %}
                    {{ monitoring_form }}
                    <i class="icon-minus-sign"></i>
                    <button type="submit" class="btn btn-info btn-small">Interrompi il monitoraggio</button>
                  </form>
                  {% else %}
                    <form action="{% url om_monitoring_start %}" method="post">
                      {% csrf_token %}
                      {{ monitoring_form }}
                      <button type="submit" class="btn btn-info btn-mini"><i class="socialicon-add"></i> Avvia il monitoraggio</button>
                    </form>
                  {% endif %}
                {% endif %}
            </th>
        </tr>
        <tr>
            <td><span class="greenbox">0</span></td>
            <th class="bg-dark span12">
                politici che monitorano l'atto <br>
                <span class="monitoring"><a href="#"><i class="socialicon-add"></i> Monitora</a></span>
            </th>
        </tr>
    </table>
</section>

<section><h3>Vota</h3>
  {% include "acts/act_vote_block.html" %}
</section>

{% get_comment_count for act as comment_count %}
{% get_comment_list for act as comment_list %}
{% get_comment_form for act as form %}
<section><h3>Commenti ({{ comment_count }})</h3>
    <ul class="people-list">
        {% for comment in comment_list %}
        <li class="bg-light"> <!-- make control for different comment opinion, like positive comment use .bg-lightgreen -->
            <a href="#"><img src="http://placehold.it/50x50" alt="" /></a>
            <a href="#">{{ comment.user.username|capfirst }}</a> {{ comment.comment }}
            {% if comment.user == request.user and comment|comment_TTL > 0 %}
            <div class="comment-delete">
                {% blocktrans with seconds=comment|comment_TTL %}You still have {{ seconds }} seconds to delete this comment{% endblocktrans %}
                <form action="{% url comments-delete-own-comment comment.id %}" method="post">
                    {% csrf_token %}
                    <input type="submit" name="submit" value="{% trans 'Delete' %}">
                </form>
                {% comment %}
                <!-- A simple anchor tag instead of the form can work
                     too, but the form ``csrf_token`` provide some
                     additional security!  Yep, bit of a paranoyd
                     thing indeed! ;-) -->
                <a href="{% url comments-delete-own-comment comment.id %}">Remove comment</a>
                {% endcomment %}
            </div>
            {% endif %}
            
            <span id="comments-votebox-{{ comment.id }}" class="monitoring">
                {% if comment.mood = "+" %}<i class="socialicon-ok"></i>{% else %}
                {% if comment.mood = "-" %}<i class="socialicon-ko"></i>{% else %}
                {% if comment.mood = "0" %}<i class="socialicon-five"></i>{% endif %}{% endif %}{% endif %}
                 &middot; {{ comment.submit_date|date:"d M Y" }}  &middot; 
                <a href="#">Condividi</a>  &middot; 
                {% score_for_object comment as comment_score %}
                {% if request.user.is_authenticated %}
                {% vote_by_user request.user on comment as vote %}
                <a href="#" id="comments-vote-{{ comment.id }}-up" class='vote{% if vote.vote and vote.vote > 0 %} up-voted{% endif %}'><span class='notlike'>Non mi piace pi&ugrave</span><span class='like'>Mi piace</span></a>  &middot; 
                {% else %}
                <a href="#" class="vote"><span class='like'>Mi piace</span></a>  &middot;                 
                {% endif %}
                <i class="socialicon-add"></i> <span class="okscore">{{ comment_score.score }}</span>
            </span>
        </li>
        {% endfor %}
    </ul>
    {% if request.user.is_authenticated %}
    <form action="{% comment_form_target %}" method="post" class="form-inline bg-dark">
        {% csrf_token %}
        {% for field in form %}
        {% if field.is_hidden %}{{ field }}{% else %}
        {% if field.name != "name" and field.name != "email" and field.name != "url" %}{% if field.errors %}{{ field.errors }}{% endif %}{{ field }}{% endif %}{% endif %}
        {% endfor %}
        <input type="submit" name="submit" value="{% trans 'Post' %}">
        
        <!--<i class="socialicon-ok"></i><i class="socialicon-ko"></i><i class="socialicon-five"></i>-->
        <!--<input type="text" placeholder="Scrivi un commento..." /> -->               
    </form>
    {% endif %}  
    
    <p>Leggi tutti (Cronologia) <i class="icon-chevron-down"></i></p>
</section>

<section>
    <h3>Ultime sugli Atti <img src="{{ STATIC_URL }}img/feed-icon-14x14.png" alt="" /></h3>

    <ul class="feed-list">
        {% institutional_news_for_object act as i_news %}
        {% for n in i_news %}
            <li>{{ n.created|date:"d-m-Y" }} - {{ n.text|safe }}</li>
        {% endfor %}
    </ul>
    <p class="bg-dark">Leggi tutti (Cronologia) <i class="icon-chevron-down"></i></p>
</section>

<section>
    <h3>Ultime dalla community <img src="{{ STATIC_URL }}img/feed-icon-14x14.png" alt="" /></h3>

    <ul class="feed-list">
        {% community_news_for_object act as c_news %}
        {% for n in c_news %}
            <li>{{ n.created|date:"d-m-Y" }} - {{ n.text|safe }}</li>
        {% endfor %}
    </ul>
    <p class="bg-dark">Leggi tutte (Cronologia) <i class="icon-chevron-down"></i></p>
</section>
{% endblock %}
