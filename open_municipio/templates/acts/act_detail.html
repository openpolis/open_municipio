{% extends "acts/act_section.html" %}
{% load i18n %}
{% load om_comments_tags %}
{% load comments %}
{% load voting_tags %}
{% load newscache_tags %}

{% comment %}Bookmarking tags{% endcomment %}
{% load om_utils %}
{% load bookmarking_tags %}

{% comment %}WebServices tags: share{% endcomment %}
{% load web_services_tags %}

{% block title %}Dettaglio {{ act }}{% endblock title %}
{% block content_header %}Dettaglio atto{% endblock %}
{% block body_class %}act{% endblock %}
{% block acts_class %}active{% endblock %}

{% block head_css_includes %}
    {{ block.super }}
    <link href="{{ STATIC_URL }}css/voting.css" rel="stylesheet">    
{% endblock head_css_includes %}

{% block head_js_includes %}
  {{ block.super }}
  <script src="{{ STATIC_URL }}js/ajax_csrf.js" type="text/javascript" charset="utf-8"></script>
  <script src="{{ STATIC_URL }}js/jquery.jeditable.js" stype="text/javascript"></script>
  <script src="{{ STATIC_URL }}js/jquery.submitlink.js" stype="text/javascript"></script>
  <script src="{{ STATIC_URL }}js/jquery.autogrow.js" stype="text/javascript"></script>
{% endblock head_js_includes %}


{% block content %}
  <table class="" style="position: absolute; top:0; right: 0;">
    <tr>
      <td>
        {{ act.presentation_date|circled:"full,colored" }}
      </td>
      <td><p>Prossima <br>discussione</p></td>
    </tr>
  </table>

  <hgroup>
    <h2 id="act_title">
      <i id="{{ act|as_token }}" class="bookmarkable {% is_key_class act %}"></i>
      <strong class="input-append">{{ act.title }}</strong>
      <small>(N. {{ act.idnum }})</small></h2>
    <h4>
      {% block act_type %}TIPO ATTO{% endblock %}
      del Consiglio comunale N° <strong>{{ act.idnum }}</strong> del <strong><span class="date">{{ act.presentation_date }}</span></strong>
    </h4>
  </hgroup>

  <div>
    <p{% if act.description|length > 0 %} class="quoted"{% endif %} id="act_description">{{ act.description|safe }}</p>
    {% for descriptor in act.descriptors %}
      <i class="icon-ok"></i> <a href="{{ descriptor.get_absolute_url }}">{{ descriptor }}</a>
    {% endfor %}
  </div>

  <div class="nav-tabs-container">
    <ul class="nav nav-tabs page-tabs">
      <li {% block act_tab_status_class %}class="active"{% endblock %}> <a href="{{ act.get_absolute_url }}">Stato</a></li>
      <li {% block act_tab_documents_class %}{% endblock %}><a href="{{ act.get_absolute_url }}documents">Documenti</a></li>
      <li><a href="{{ act.get_absolute_url }}votes"><strong>Voti</strong></a></li>
    </ul>
  </div>

  {% block act_tab_body %}
    {% include 'acts/act_table_transitions.html' %}
  {% endblock act_tab_body %}

  {% share act %}
{% endblock content %}


{% block sidebar %}

  {% if topics %}
  {% include 'acts/act_tags_editor.html' with launcher_id="#cteditor-launcher" %}
  {% endif %}

  <section>
    <h3>Argomenti dell'atto
    {% if topics %}
      <a href="#" id="cteditor-launcher" class="label label-info">
        <i class="icon-edit icon-white"></i> Edit
      </a>
    {% endif %}
    </h3>

    <dl class="taxonomy-cloud">
      {% regroup act.topics by category as categorized_topics %}
      {% for grouped_tags in categorized_topics %}
        <dt><a href="{{ grouped_tags.grouper.get_absolute_url }}">{{ grouped_tags.grouper.name }}</a></dt>
        {% for topic in grouped_tags.list %}
        {% if topic.tag %}
        <dd><a href="{{ topic.tag.get_absolute_url }}">{{ topic.tag }}</a></dd>
        {% endif %}
        {% endfor %}
      {% endfor %}

      {% for location in act.locations %}
        {% if forloop.first %}
          {% if location_form %}
          <dt><a href="#" id="location_form_link"><i class="icon-edit"></i></a> Territorio</dt>
          {% else %}
          <dt>Territorio</dt>
          {% endif %}
        {% endif %}
        <dd><a href="{{ location.get_absolute_url }}">{{ location }}</a></dd>
      {% empty %}
        {% if location_form %}
          <dt><a href="#" id="location_form_link"><i class="icon-edit"></i></a> Territorio</dt>
        {% endif %}
      {% endfor %}
    </dl>

    {% if location_form %}
    <form id="location-form" data-toggle="#location_form_link" class="form-inline" action="{% url om_act_locations_add pk=act.act_ptr.pk %}" method="post">
      {% csrf_token %}{% for hidden in location_form.hidden_fields %}{{ hidden }}{% endfor %}
      {{ location_form.locations }}
      <div class="form-actions text-center">
        <button type="submit" class="btn btn-info btn-mini">Applica</button>
      </div>
    </form>
    <script type="text/javascript">
      $(document).ready(function(){
        var form = $('#location-form').hide();
        $( form.data('toggle') ).click(function(){
          $('#location-form').slideToggle();
          return false;
        });
      });
    </script>
    {% endif %}

  </section>

  <hr>

  <section>
    <h3>Monitora</h3>
    {% include 'monitoring/summary.html' with object=act show_politicians=1 %}
  </section>

  <hr>

  <section>
    <h3>Vota</h3>
    {% include "acts/act_vote_block.html" %}
  </section>

  <hr>

{% get_comment_count for act as comment_count %}
{% get_comment_list for act as comment_list %}
{% get_comment_form for act as form %}
  <section>
    <h3>Commenti ({{ comment_count }})</h3>

    <ul class="comments-list">
      {% for comment in comment_list %}
      <li{% if user.is_authenticated and user.get_profile.person %} class="bg-highlight"{% endif %}>
        <a href="{% url users_user_detail comment.user.username %}">
          <img src="{{ STATIC_URL }}img/placehold/50.gif" />
        </a>

        <div>
          {% if comment.user == request.user and comment|comment_TTL > 0 %}
            <a href="#" class="pull-right bg-light" title="{% blocktrans with seconds=comment|comment_TTL %}You still have {{ seconds }} seconds to delete this comment{% endblocktrans %}"><i class="icon-remove"></i></a>
            <form action="{% url comments-delete-own-comment comment.id %}" class="comment-form-delete" method="post">{% csrf_token %}
              <button type="submit" class="btn btn-danger btn-mini">{% trans 'Delete' %}</button>
            </form>
          {% endif %}

          <p>
            <a href="{% url users_user_detail comment.user.username %}">{{ comment.user.username|capfirst }}</a>
            {{ comment.comment }}
          </p>

          {% if comment.mood == "+" %}<i class="hand-ok hand-active"></i>{% else %}
          {% if comment.mood == "-" %}<i class="hand-ko hand-active"></i>{% else %}
          {% if comment.mood == "0" %}<i class="hand-five hand-active"></i>{% endif %}{% endif %}{% endif %}
          &middot; {{ comment.submit_date|date:"d M Y" }}  &middot;
          {% score_for_object comment as comment_score %}
          {% if request.user.is_authenticated %}
            {% vote_by_user request.user on comment as vote %}
            <a href="#" id="comments-vote-{{ comment.id }}-up" class='vote{% if vote.vote and vote.vote > 0 %} up-voted{% endif %}'><span class='notlike'>Non mi piace pi&ugrave</span><span class='like'>Mi piace</span></a>  &middot;
          {% else %}
            <a href="#" class="vote"><span class='like'>Mi piace</span></a>  &middot;
          {% endif %}
          <i class="hand-like"></i> <span class="okscore">{{ comment_score.score }}</span>
        </div>
      </li>
      {% endfor %}
    </ul>

    {% if request.user.is_authenticated %}
    <form id="comment-form" action="{% comment_form_target %}" method="post" class="form-inline box">
      <input type="hidden" name="next" value="{{ act.get_absolute_url }}" />
      {% csrf_token %}
      {% for hidden in form.hidden_fields %}
        {{ hidden }}
      {% endfor %}

      <p>
        <textarea name="{{ form.comment.html_name }}" class="input-expanded" data-plugin="autogrow" placeholder="Inserisci un commento" id="comment-form-text" rows="1"></textarea>
      </p>

      <button type="submit" class="btn btn-mini pull-right" id="comment-form-submit">{% trans 'Post' %} </button>

      <p>
        <label for="{{ form.mood.html_name }}">Scegli la posizione</label> {{ form.mood }}
      </p>

    </form>
    {% endif %}

    <p class="box">
      <a href="#">Leggi tutti</a> <i class="icon-play-down"></i>
    </p>
  </section>

  <hr>

  <section>
    <h3>Ultime sugli Atti <img src="{{ STATIC_URL }}img/feed-icon-14x14.png" alt="" /></h3>

    <ul class="list-simple">
      {% institutional_news_for_object act as i_news %}
      {% for n in i_news %}
      <li>{{ n.created|date:"d-m-Y" }} - {{ n.text|safe }}</li>
      {% endfor %}
    </ul>

    <p class="box">
      <a href="#">Leggi tutti</a> <i class="icon-play-down"></i>
    </p>
  </section>

{% endblock %}


{% block footer_js_includes %}
  {{ block.super }}
  <script type="text/javascript">

    {% if request.user.is_authenticated %}

      $(document).ready(function(){

        {% if title_form %}
        // Edit Act Title in-place
        $('#act_title strong').editable('{% url om_act_title_update pk=act.id %}', {
          name : '{{ title_form.title.html_name }}',
          submitdata : function(value, settings) {
            return { 'id': {{ act.id }}, 'act_field': 'title' };
          },
          cssclass  : 'form-inline',
          submit    : '<button type="submit" class="btn">Salva</button>',
          indicator : '<img src="{{ STATIC_URL }}img/spinner.gif">',
          tooltip   : 'Clicca per modificare...',
          style     : 'display: inline',
          //onblur     : 'ignore',
          inputclass : 'input-xxlarge',
          callback : function(value){
            value = JSON.parse(value)
            // TODO check if there's some errors
            $(this).text(value.text)
          }
        });
        {% endif %}

        // ----------------------------

        {% if description_form %}
          // Edit Act Description in-place
        $('#act_description').editable('{% url om_act_description_update pk=act.id %}', {
          type: 'autogrow',
          name : '{{ description_form.description.html_name }}',
          submitdata : function(value, settings) {
            return { 'id': {{ act.id }}, 'act_field': 'description' };
          },
          cssclass  : 'form-inline',
          submit    : '<button type="submit" class="btn">Salva</button>',
          indicator : '<img src="{{ STATIC_URL }}img/spinner.gif">',
          tooltip   : 'Clicca per modificare...',
          style     : 'display: inline',
          //onblur     : 'ignore',
          inputclass : 'input-xxlarge',
          callback : function(value){
            value = JSON.parse(value)
            // TODO check if there's some errors
            $(this).text(value.text)
          }
        });
        {% endif %}

        // ----------------------------

        // Replace form to remove own comments with link
        $('.comments-list').find('form.comment-form-delete').each(function(){
          $(this).submitLink({ link: $(this).prev('a') })
        });

        // ----------------------------

        // Commenting Form
        var $comment_form = $('#comment-form')
        var $comment_form_submit = $('#comment-form-submit')

        // prevent empty submit
        $comment_form.submit(function(){
          var field = $(this).find('textarea');
          if (field.length && (field.val().length == 0) ) {
            alert('Attenzione, il commento è vuoto.');
            return false;
          }
        });

        var selectHand = function() {
          el = $(this);
          // de-activate icon
          el.parent().find('.hand-active').removeClass('hand-active');
          // clean send button
          $('i', $comment_form_submit).remove();
          // inject new hand
          $comment_form_submit.prepend($('<i />').addClass( el.data('icon') ).addClass('hand-active'));
          // set radiobox as checked
          el.addClass('hand-active').find('input').prop('checked', true);
        };

        $comment_form.find('label').each(function(){
          var icon,
              $label = $(this),
              $input = $label.find('input:radio')

          if ( $input.length == 0 ) return

          // store icon
          switch ($input.prop('value'))
          {
            case '+':
              $label.data('icon','hand-ok')
              break;
            case '0':
              $label.data('icon','hand-five')
              break;
            case '-':
              $label.data('icon','hand-ko')
              break;
          }

          // default radio
          if ($input.prop('checked'))
          {
            $comment_form_submit.prepend(
                $('<i />').addClass( $label.data('icon')).addClass('hand-active')
            )
            $label.addClass('hand-active')
          }

          $label
              .prop('title', $label.text().trim() )
              .css({
                'text-indent': '-99999px',
                'overflow': 'hidden',
                'cursor': 'pointer'
              })
              .addClass( $label.data('icon') )
              .click( selectHand )
        })

      });

    {% endif %}

  </script>
{% endblock %}

